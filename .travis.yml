dist: trusty

addons:
  postgresql: 9.4
  sonarcloud:
    organization: "defra"

env:
  global:
    - ADDRESS_FACADE_CLIENT_ID=0
    - ADDRESS_FACADE_KEY=client1
    - ADDRESS_FACADE_PORT=9002
    - ADDRESS_FACADE_SERVER=localhost
    - DEVISE_MAILER_SENDER="John Smith <js@example.com>"
    - EMAIL_HOST=localhost
    - EMAIL_PORT=2500
    - SECRET_KEY_BASE=00c33aa9929a0b2fdf6388368469a796fb3d812bee94349d5d9f3a81ecaf35e9195b7ad98bc3a42f27681dd2e6a9b56c589180842ef15630a775f68ccbc2dfc2

language: ruby
rvm: 2.3.1
cache: bundler

# Travis CI uses shallow clone to speed up build times, but a truncated SCM
# history may cause issues when SonarCloud computes blame data. To avoid this,
# you can access the full SCM history with `depth: false`
git:
  depth: false

before_install:
  - export TZ=UTC
  - gem install -v 1.17.3 bundler --no-document

before_script:
  # Replace database.yml with database.travis.yml (but leave filename as
  # database.yml). database.travis.yml is the config needed for Travis, and it
  # needs to be in place before we run the migrations.
  - cp spec/dummy/config/database.travis.yml spec/dummy/config/database.yml
  - RAILS_ENV=test bundle exec rake db:create --trace
  - RAILS_ENV=test bundle exec rake db:migrate --trace

script:
  - bundle exec rubocop --format progress --format json --out rubocop-result.json
  - bundle exec rspec
  - sonar-scanner
